# A handler for stin, just for testing purposes
#- module: StdInHandler
#  receivers:
#    - RegexStringParser

# A simple TCP Server 
- module: TcpServerThreaded
  configuration:
    interface: localhost
    port: 5152
  receivers: 
    - RegexStringParser

# Parse the messege using named regex patterns.
# The named groups will be put into correspondig fields in the data dictionary
- module: RegexStringParser
  configuration:
    # Set marker if a regex matched
    mark-on-success: match
    # Set marker if no regex matched
    mark-on-failure: nomatch
    field_extraction_patterns:
      httpd_access_log: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\-\._]+)\s+(apache2|nginx): httpd\[(?P<pid>\d+)\]\s+(?P<virtual_host_name>.*)\s+(?P<remote_ip>\d+\.\d+\.\d+\.\d+)\s+(?P<request_time>[\d\.]+)\s+\"(?P<http_method>GET|POST)\s+(?P<uri>.*)\"\s+(?P<http_status>-|\d+)\s+(?P<bytes_sent>-|\d+)\s+(?P<cookie_sid>\S+)\s+(?P<cookie_unique_id>\S+)\s+\"(?P<referer>.*)\"\s+\"(?P<user_agent>.*)\"'
      agora_access_log: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\._\-]+)\s+nginx: agora (?P<request_ts>\d+\.\d+).*\s(?P<server_name>[\w\._\-]+)\s(?P<http_method>[\w\-]+)\s\"(?P<uri>.*)\"\s\"(?P<request_body>.*)\"\s(?P<username>[\w\-]+)\s(?P<http_status>\d+)\s(?P<bytes_sent>\d+)\s(?P<request_size>\d+)\s(?P<request_time>[\d\.]+)\s(?P<remote_ip>[\d\.]+)\s(?P<remote_port>\d+)\s\"(?P<x_forwarded_for>.*)\"\s\"(?P<referer>.*)\"\s\"(?P<user_agent>.*)\"\s(?P<cache_status>[\w\-]+)\s\"(?P<upstream_response_time>.*)\"\s\"(?P<upstream_addr>.*)\"\s\"(?P<content_type>.*)\"\s\"(?P<accept_encoding>.*)\"\s\"(?P<content_encoding>.*)\"\s\"(?P<custom_vars>.*)'
      httpd_log_phperrors: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\-\._]+)\s+httpd\[(?P<pid>\d+)\]:?\s(\[(?P<status>\w+)\]\s+)?\[client\s+(?P<remote_ip>\d+\.\d+\.\d+\.\d+)\]\s+PHP (?P<php_error_type>Warning|Notice|Fatal error):\s+(?P<php_error_message>.*)'
      php_fpm_log_errors: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\-\._]+)\s+php-fpm\[(?P<pid>\d+)\]:?\s\[(?P<php_error_type>\w+)\]\s+\[pool\s(?P<php_fpm_poolname>[\w\-\._\s]+)\]\s+(?P<php_error_message>.*)'
      httpd_log_errors: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\-\._]+)\s+httpd\[(?P<pid>\d+)\]:?\s\[(?P<status>\w+)\]\s+\[client\s+(?P<remote_ip>\d+\.\d+\.\d+\.\d+)\]\s+(?P<httpd_error_message>.*)'
      daemontools: '(?P<log_timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>[\w\-\._]+)\s+daemontools\.(?P<service_name>\w+):\s+(?P<log_message>.*)'
  receivers:
    # Only messages that matched a regex will be send to this handler
    - ModuleContainer:
        filter-by-marker: match
    # Print out messages that did not match
    - StdOutHandler:
        filter-by-marker: nomatch

# Normal handlers will always run in their own thread and need an input and output queue.
# To avoid this overhead for simple tasks, wrap them up in a container.
- module: ModuleContainer
  configuration:
    - module: AddTimeStamp
    - module: AddGeoInfo
      configuration:
        geoip_dat_path: /usr/share/GeoIP/GeoIP.dat
  receivers:
    - MessageAggregator
    - Statistics

# Aggregate the messages before sending them to the output handler, so that a bulk update really makes sense.
- module: MessageAggregator
  configuration:
    store_data_interval: 25
  receivers: 
    - ElasticSearchStorageHandler

# Add messages to ES
- module: ElasticSearchStorageHandler
  pool-size: 4
  configuration:
    host: localhost:9200
    index_prefix: test-
    field_types: 
      bytes_sent: Integer
      http_status: Integer
      pid: Integer
      remote_port: Integer
      request_time: Integer
      request_size: Integer

- module: Statistics
  configuration:
    print_regex_statistics_at_message_count: 1000
    regexStatistics: True
    receiveRateStatistics: True

#- module: StdOutHandler
#- module: DevNullSink

#- module: TcpServerTwisted
#  configuration:
#    TCP: 5152
#  receivers: 
#    - SyslogMessageParser